import React, { useState, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { Upload, X, Image, CheckCircle, AlertCircle, Folder } from 'lucide-react';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';

const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

// Função para extrair cor dominante
const getDominantColor = (imageUrl) => {
    return new Promise((resolve) => {
        const img = document.createElement('img');
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 50;
            canvas.height = 50;
            ctx.drawImage(img, 0, 0, 50, 50);
            
            const imageData = ctx.getImageData(0, 0, 50, 50).data;
            let r = 0, g = 0, b = 0, count = 0;
            
            for (let i = 0; i < imageData.length; i += 4) {
                r += imageData[i];
                g += imageData[i + 1];
                b += imageData[i + 2];
                count++;
            }
            
            r = Math.round(r / count);
            g = Math.round(g / count);
            b = Math.round(b / count);
            
            const hex = '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
            resolve(hex);
        };
        img.onerror = () => resolve('#808080');
        img.src = imageUrl;
    });
};

// Função para extrair dimensões da imagem
const getImageDimensions = (file) => {
    return new Promise((resolve) => {
        const img = document.createElement('img');
        img.onload = () => {
            resolve({ width: img.width, height: img.height });
            URL.revokeObjectURL(img.src);
        };
        img.onerror = () => resolve({ width: 0, height: 0 });
        img.src = URL.createObjectURL(file);
    });
};

export default function PhotoUploader({ albumId, onUploadComplete }) {
    const [isDragging, setIsDragging] = useState(false);
    const [files, setFiles] = useState([]);
    const [uploading, setUploading] = useState(false);
    const [uploadProgress, setUploadProgress] = useState(0);

    const validateFile = (file) => {
        if (!ALLOWED_TYPES.includes(file.type)) {
            return { valid: false, error: 'Tipo de arquivo não suportado' };
        }
        if (file.size > MAX_FILE_SIZE) {
            return { valid: false, error: 'Arquivo muito grande (máx. 10MB)' };
        }
        return { valid: true };
    };

    const handleFiles = useCallback((fileList) => {
        const newFiles = Array.from(fileList).map(file => {
            const validation = validateFile(file);
            return {
                file,
                id: Math.random().toString(36).substring(7),
                name: file.name,
                size: file.size,
                preview: URL.createObjectURL(file),
                status: validation.valid ? 'pending' : 'error',
                error: validation.error
            };
        });
        setFiles(prev => [...prev, ...newFiles]);
    }, []);

    const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragging(true);
    };

    const handleDragLeave = (e) => {
        e.preventDefault();
        setIsDragging(false);
    };

    const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        handleFiles(e.dataTransfer.files);
    };

    const handleFileInput = (e) => {
        if (e.target.files) {
            handleFiles(e.target.files);
        }
    };

    const handleFolderInput = (e) => {
        if (e.target.files) {
            handleFiles(e.target.files);
        }
    };

    const removeFile = (id) => {
        setFiles(prev => {
            const file = prev.find(f => f.id === id);
            if (file) URL.revokeObjectURL(file.preview);
            return prev.filter(f => f.id !== id);
        });
    };

    const uploadFiles = async () => {
        const validFiles = files.filter(f => f.status === 'pending');
        if (validFiles.length === 0) {
            toast.error('Nenhum arquivo válido para enviar');
            return;
        }

        setUploading(true);
        let uploaded = 0;

        for (const fileData of validFiles) {
            setFiles(prev => prev.map(f => 
                f.id === fileData.id ? { ...f, status: 'uploading' } : f
            ));

            try {
                // Upload do arquivo
                const { file_url } = await base44.integrations.Core.UploadFile({ 
                    file: fileData.file 
                });

                // Extrair cor dominante e dimensões
                const [dominantColor, dimensions] = await Promise.all([
                    getDominantColor(file_url),
                    getImageDimensions(fileData.file)
                ]);

                // Criar registro da foto
                await base44.entities.Photo.create({
                    album_id: albumId,
                    title: fileData.name.replace(/\.[^/.]+$/, ''),
                    file_url: file_url,
                    thumbnail_url: file_url,
                    file_size: fileData.file.size,
                    dominant_color: dominantColor,
                    width: dimensions.width,
                    height: dimensions.height,
                    acquisition_date: new Date().toISOString()
                });

                setFiles(prev => prev.map(f => 
                    f.id === fileData.id ? { ...f, status: 'success' } : f
                ));

                uploaded++;
                setUploadProgress((uploaded / validFiles.length) * 100);
            } catch (error) {
                setFiles(prev => prev.map(f => 
                    f.id === fileData.id ? { ...f, status: 'error', error: 'Falha no upload' } : f
                ));
            }
        }

        setUploading(false);
        setUploadProgress(0);

        if (uploaded > 0) {
            toast.success(`${uploaded} foto(s) enviada(s) com sucesso!`);
            onUploadComplete();
        }
    };

    const formatSize = (bytes) => {
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    };

    return (
        <div className="space-y-4">
            {/* Zona de Drop */}
            <div
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                className={`
                    relative border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200
                    ${isDragging 
                        ? 'border-violet-500 bg-violet-50' 
                        : 'border-slate-200 hover:border-violet-300 hover:bg-slate-50'
                    }
                `}
            >
                <input
                    type="file"
                    multiple
                    accept={ALLOWED_TYPES.join(',')}
                    onChange={handleFileInput}
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                    id="file-input"
                />
                
                <div className="space-y-3">
                    <div className="w-16 h-16 mx-auto rounded-full bg-violet-100 flex items-center justify-center">
                        <Upload className="w-8 h-8 text-violet-600" />
                    </div>
                    <div>
                        <p className="text-lg font-medium text-slate-700">
                            Arraste suas fotos aqui
                        </p>
                        <p className="text-sm text-slate-500">
                            ou clique para selecionar arquivos
                        </p>
                    </div>
                    <p className="text-xs text-slate-400">
                        JPG, PNG, GIF, WebP • Máx. 10MB por arquivo
                    </p>
                </div>
            </div>

            {/* Botão para upload de pasta */}
            <div className="flex justify-center">
                <label className="cursor-pointer">
                    <input
                        type="file"
                        webkitdirectory=""
                        directory=""
                        multiple
                        accept={ALLOWED_TYPES.join(',')}
                        onChange={handleFolderInput}
                        className="hidden"
                    />
                    <Button variant="outline" className="gap-2" asChild>
                        <span>
                            <Folder className="w-4 h-4" />
                            Enviar pasta inteira
                        </span>
                    </Button>
                </label>
            </div>

            {/* Lista de arquivos */}
            {files.length > 0 && (
                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                        <p className="text-sm font-medium text-slate-700">
                            {files.length} arquivo(s) selecionado(s)
                        </p>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => setFiles([])}
                            className="text-slate-500"
                        >
                            Limpar tudo
                        </Button>
                    </div>

                    <div className="max-h-60 overflow-y-auto space-y-2">
                        <AnimatePresence>
                            {files.map((file) => (
                                <motion.div
                                    key={file.id}
                                    initial={{ opacity: 0, height: 0 }}
                                    animate={{ opacity: 1, height: 'auto' }}
                                    exit={{ opacity: 0, height: 0 }}
                                    className="flex items-center gap-3 p-2 rounded-lg bg-slate-50"
                                >
                                    <div className="w-12 h-12 rounded-lg overflow-hidden bg-slate-200 flex-shrink-0">
                                        <img 
                                            src={file.preview} 
                                            alt={file.name}
                                            className="w-full h-full object-cover"
                                        />
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className="text-sm font-medium text-slate-700 truncate">
                                            {file.name}
                                        </p>
                                        <p className="text-xs text-slate-500">
                                            {formatSize(file.size)}
                                        </p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {file.status === 'pending' && (
                                            <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center">
                                                <Image className="w-3 h-3 text-slate-500" />
                                            </div>
                                        )}
                                        {file.status === 'uploading' && (
                                            <div className="w-6 h-6 rounded-full border-2 border-violet-500 border-t-transparent animate-spin" />
                                        )}
                                        {file.status === 'success' && (
                                            <CheckCircle className="w-6 h-6 text-emerald-500" />
                                        )}
                                        {file.status === 'error' && (
                                            <div className="flex items-center gap-1">
                                                <AlertCircle className="w-5 h-5 text-red-500" />
                                                <span className="text-xs text-red-500">{file.error}</span>
                                            </div>
                                        )}
                                        {file.status !== 'uploading' && (
                                            <Button
                                                variant="ghost"
                                                size="icon"
                                                className="h-6 w-6"
                                                onClick={() => removeFile(file.id)}
                                            >
                                                <X className="w-4 h-4" />
                                            </Button>
                                        )}
                                    </div>
                                </motion.div>
                            ))}
                        </AnimatePresence>
                    </div>

                    {uploading && (
                        <div className="space-y-2">
                            <Progress value={uploadProgress} className="h-2" />
                            <p className="text-xs text-center text-slate-500">
                                Enviando... {Math.round(uploadProgress)}%
                            </p>
                        </div>
                    )}

                    <Button
                        onClick={uploadFiles}
                        disabled={uploading || files.filter(f => f.status === 'pending').length === 0}
                        className="w-full bg-violet-600 hover:bg-violet-700"
                    >
                        {uploading ? 'Enviando...' : 'Enviar Fotos'}
                    </Button>
                </div>
            )}
        </div>
    );
}